<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient History - Pre-Authorization System</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <div id="sidebarContainer"></div>
    <div class="lg:ml-64">
        <nav class="bg-white shadow-sm border-b fixed top-0 left-0 right-0 z-30">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 lg:ml-64">
                <div class="flex justify-between h-16">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 flex items-center">
                            <svg class="h-8 w-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                            <span class="ml-2 text-xl font-semibold text-gray-900">Pre-Auth System</span>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <span class="text-sm text-gray-700 mr-4" id="currentUserName">User</span>
                        <button onclick="logout()" class="text-sm text-red-600 hover:text-red-800">Logout</button>
                    </div>
                </div>
            </div>
        </nav>

        <div class="pt-16 px-4 sm:px-6 lg:px-8 py-8">
            <div class="max-w-6xl mx-auto">
                <div class="mb-8">
                    <h1 class="text-3xl font-bold text-gray-900">Patient History</h1>
                    <p class="mt-2 text-gray-600">View all pre-authorization requests for this patient</p>
                </div>

                <!-- Patient Info -->
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">Patient Information</h2>
                    <div class="grid grid-cols-3 gap-4 text-sm">
                        <div><span class="text-gray-500">Name:</span> <span id="patientName" class="font-medium"></span></div>
                        <div><span class="text-gray-500">Patient ID:</span> <span id="patientId" class="font-medium"></span></div>
                        <div><span class="text-gray-500">Age:</span> <span id="patientAge" class="font-medium"></span></div>
                        <div><span class="text-gray-500">Gender:</span> <span id="patientGender" class="font-medium"></span></div>
                        <div><span class="text-gray-500">Insurance:</span> <span id="insuranceNumber" class="font-medium"></span></div>
                        <div><span class="text-gray-500">Total Requests:</span> <span id="totalRequests" class="font-medium"></span></div>
                    </div>
                </div>

                <!-- Statistics -->
                <div class="grid grid-cols-4 gap-6 mb-6">
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">Total Requests</p>
                                <p class="text-2xl font-bold text-gray-900" id="statTotal">0</p>
                            </div>
                            <div class="h-12 w-12 bg-blue-100 rounded-lg flex items-center justify-center">
                                <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">Approved</p>
                                <p class="text-2xl font-bold text-green-600" id="statApproved">0</p>
                            </div>
                            <div class="h-12 w-12 bg-green-100 rounded-lg flex items-center justify-center">
                                <svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">Rejected</p>
                                <p class="text-2xl font-bold text-red-600" id="statRejected">0</p>
                            </div>
                            <div class="h-12 w-12 bg-red-100 rounded-lg flex items-center justify-center">
                                <svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">Pending</p>
                                <p class="text-2xl font-bold text-yellow-600" id="statPending">0</p>
                            </div>
                            <div class="h-12 w-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                                <svg class="h-6 w-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filters -->
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                            <select id="statusFilter" onchange="filterRequests()" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                <option value="">All Statuses</option>
                                <option value="approved">Approved</option>
                                <option value="rejected">Rejected</option>
                                <option value="submitted">Submitted</option>
                                <option value="under_review">Under Review</option>
                                <option value="more_info_needed">More Info Needed</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Date From</label>
                            <input type="date" id="dateFrom" onchange="filterRequests()" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Date To</label>
                            <input type="date" id="dateTo" onchange="filterRequests()" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        </div>
                    </div>
                </div>

                <!-- Timeline View -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-6">Request Timeline</h2>
                    <div id="timeline" class="space-y-4"></div>
                    <div id="emptyState" class="hidden text-center py-12">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                        <p class="mt-4 text-gray-500">No requests found</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="hidden fixed bottom-4 right-4 px-6 py-4 rounded-lg shadow-lg z-50"></div>

    <script src="../assets/js/mock-data-complete.js"></script>
    <script src="../assets/js/validation.js"></script>
    <script src="../assets/js/state-management.js"></script>
    <script src="../assets/js/edge-cases.js"></script>
    <script src="../assets/js/sidebar.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const patientIdParam = urlParams.get('patientId');
        let allRequests = [];
        let filteredRequests = [];

        function initPatientHistory() {
            const user = getCurrentUser();
            if (user) document.getElementById('currentUserName').textContent = user.nameEN;
            
            if (!patientIdParam) {
                showToast('Patient ID not provided', 'error');
                setTimeout(() => window.location.href = '../reviewer/dashboard.html', 2000);
                return;
            }
            
            loadPatientHistory();
        }

        function loadPatientHistory() {
            allRequests = mockRequests.filter(r => r.patientId === patientIdParam);
            
            if (allRequests.length === 0) {
                document.getElementById('emptyState').classList.remove('hidden');
                return;
            }
            
            const firstRequest = allRequests[0];
            document.getElementById('patientName').textContent = firstRequest.patientName;
            document.getElementById('patientId').textContent = firstRequest.patientId;
            document.getElementById('patientAge').textContent = firstRequest.patientAge || 'N/A';
            document.getElementById('patientGender').textContent = firstRequest.patientGender || 'N/A';
            document.getElementById('insuranceNumber').textContent = firstRequest.insuranceNumber || 'N/A';
            document.getElementById('totalRequests').textContent = allRequests.length;
            
            updateStatistics();
            filterRequests();
        }

        function updateStatistics() {
            const approved = allRequests.filter(r => r.status === 'approved').length;
            const rejected = allRequests.filter(r => r.status === 'rejected').length;
            const pending = allRequests.filter(r => ['submitted', 'under_review'].includes(r.status)).length;
            
            document.getElementById('statTotal').textContent = allRequests.length;
            document.getElementById('statApproved').textContent = approved;
            document.getElementById('statRejected').textContent = rejected;
            document.getElementById('statPending').textContent = pending;
        }

        function filterRequests() {
            const status = document.getElementById('statusFilter').value;
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            
            filteredRequests = allRequests.filter(r => {
                if (status && r.status !== status) return false;
                if (dateFrom && new Date(r.submittedDate) < new Date(dateFrom)) return false;
                if (dateTo && new Date(r.submittedDate) > new Date(dateTo)) return false;
                return true;
            });
            
            renderTimeline();
        }

        function renderTimeline() {
            const timeline = document.getElementById('timeline');
            const emptyState = document.getElementById('emptyState');
            
            if (filteredRequests.length === 0) {
                timeline.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            const sorted = [...filteredRequests].sort((a, b) => new Date(b.submittedDate) - new Date(a.submittedDate));
            
            timeline.innerHTML = sorted.map(request => `
                <div class="flex gap-4 pb-4 border-b border-gray-200 last:border-0">
                    <div class="flex-shrink-0 w-24 text-sm text-gray-500">
                        ${formatDate(request.submittedDate)}
                    </div>
                    <div class="flex-shrink-0">
                        <div class="h-10 w-10 rounded-full ${getStatusColor(request.status)} flex items-center justify-center">
                            ${getStatusIcon(request.status)}
                        </div>
                    </div>
                    <div class="flex-1">
                        <div class="flex items-start justify-between">
                            <div>
                                <p class="font-medium text-gray-900">${request.testName}</p>
                                <p class="text-sm text-gray-500">Request ID: ${request.id}</p>
                                <span class="inline-block mt-2 px-3 py-1 text-xs font-semibold rounded-full ${getStatusBadgeClass(request.status)}">
                                    ${getStatusLabel(request.status)}
                                </span>
                            </div>
                            <button onclick="viewRequest('${request.id}')" class="px-4 py-2 text-sm text-blue-600 hover:text-blue-800">
                                View Details â†’
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function getStatusColor(status) {
            const colors = {
                approved: 'bg-green-100',
                rejected: 'bg-red-100',
                submitted: 'bg-blue-100',
                under_review: 'bg-yellow-100',
                more_info_needed: 'bg-orange-100',
                draft: 'bg-gray-100',
                cancelled: 'bg-gray-100'
            };
            return colors[status] || 'bg-gray-100';
        }

        function getStatusIcon(status) {
            if (status === 'approved') return '<svg class="h-5 w-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>';
            if (status === 'rejected') return '<svg class="h-5 w-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>';
            return '<svg class="h-5 w-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>';
        }

        function viewRequest(id) {
            window.location.href = `../requests/request-details.html?id=${id}`;
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const colors = {success: 'bg-green-600 text-white', error: 'bg-red-600 text-white', info: 'bg-blue-600 text-white'};
            toast.className = `fixed bottom-4 right-4 px-6 py-4 rounded-lg shadow-lg z-50 ${colors[type]}`;
            toast.textContent = message;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }

        initPatientHistory();
    </script>
</body>
</html>
