<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Draft Request - Pre-Authorization System</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
    <!-- Sidebar Container -->
    <div id="sidebarContainer"></div>

    <!-- Main Content with Sidebar Offset -->
    <div class="lg:ml-64">
        <!-- Navigation -->
        <nav class="bg-white shadow-sm border-b fixed top-0 left-0 right-0 z-30">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 lg:ml-64">
                <div class="flex justify-between h-16">
                    <div class="flex items-center">
                        <div class="flex-shrink-0 flex items-center">
                            <svg class="h-8 w-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            <span class="ml-2 text-xl font-semibold text-gray-900">Pre-Auth System</span>
                        </div>
                    </div>
                    <div class="flex items-center">
                        <span class="text-sm text-gray-700 mr-4" id="currentUserName">User</span>
                        <button onclick="logout()" class="text-sm text-red-600 hover:text-red-800">Logout</button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="pt-16 px-4 sm:px-6 lg:px-8 py-8">
            <div class="max-w-4xl mx-auto">
                <!-- Header -->
                <div class="mb-8">
                    <div class="flex items-center justify-between">
                        <div>
                            <h1 class="text-3xl font-bold text-gray-900">Edit Draft Request</h1>
                            <p class="mt-2 text-gray-600">Continue editing your draft request</p>
                        </div>
                        <span class="px-4 py-2 bg-yellow-100 text-yellow-800 text-sm font-semibold rounded-lg">Draft</span>
                    </div>
                </div>

                <!-- Draft Info -->
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">Draft Information</h2>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div><span class="text-gray-500">Request ID:</span> <span id="draftId" class="font-medium"></span></div>
                        <div><span class="text-gray-500">Last Saved:</span> <span id="lastSaved" class="font-medium"></span></div>
                        <div><span class="text-gray-500">Test:</span> <span id="draftTest" class="font-medium"></span></div>
                        <div><span class="text-gray-500">Patient:</span> <span id="draftPatient" class="font-medium"></span></div>
                    </div>
                </div>

                <!-- Wizard Steps Summary -->
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">Request Progress</h2>
                    <div class="space-y-3" id="stepsSummary"></div>
                </div>

                <!-- Quick Edit Options -->
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">Edit Sections</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <button onclick="editStep(1)" class="flex items-center justify-between p-4 border border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-colors">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 h-10 w-10 bg-blue-100 rounded-lg flex items-center justify-center">
                                    <span class="text-blue-600 font-semibold">1</span>
                                </div>
                                <div class="ml-4 text-left">
                                    <p class="text-sm font-medium text-gray-900">Test Selection</p>
                                    <p class="text-xs text-gray-500" id="step1Summary"></p>
                                </div>
                            </div>
                            <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                        </button>

                        <button onclick="editStep(2)" class="flex items-center justify-between p-4 border border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-colors">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 h-10 w-10 bg-blue-100 rounded-lg flex items-center justify-center">
                                    <span class="text-blue-600 font-semibold">2</span>
                                </div>
                                <div class="ml-4 text-left">
                                    <p class="text-sm font-medium text-gray-900">Patient Information</p>
                                    <p class="text-xs text-gray-500" id="step2Summary"></p>
                                </div>
                            </div>
                            <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                        </button>

                        <button onclick="editStep(3)" class="flex items-center justify-between p-4 border border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-colors">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 h-10 w-10 bg-blue-100 rounded-lg flex items-center justify-center">
                                    <span class="text-blue-600 font-semibold">3</span>
                                </div>
                                <div class="ml-4 text-left">
                                    <p class="text-sm font-medium text-gray-900">Clinical Symptoms</p>
                                    <p class="text-xs text-gray-500" id="step3Summary"></p>
                                </div>
                            </div>
                            <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                        </button>

                        <button onclick="editStep(4)" class="flex items-center justify-between p-4 border border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-colors">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 h-10 w-10 bg-blue-100 rounded-lg flex items-center justify-center">
                                    <span class="text-blue-600 font-semibold">4</span>
                                </div>
                                <div class="ml-4 text-left">
                                    <p class="text-sm font-medium text-gray-900">ICD-10 Codes</p>
                                    <p class="text-xs text-gray-500" id="step4Summary"></p>
                                </div>
                            </div>
                            <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                        </button>

                        <button onclick="editStep(5)" class="flex items-center justify-between p-4 border border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-colors">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 h-10 w-10 bg-blue-100 rounded-lg flex items-center justify-center">
                                    <span class="text-blue-600 font-semibold">5</span>
                                </div>
                                <div class="ml-4 text-left">
                                    <p class="text-sm font-medium text-gray-900">Clinical Justification</p>
                                    <p class="text-xs text-gray-500" id="step5Summary"></p>
                                </div>
                            </div>
                            <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                        </button>

                        <button onclick="editStep(6)" class="flex items-center justify-between p-4 border border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition-colors">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 h-10 w-10 bg-blue-100 rounded-lg flex items-center justify-center">
                                    <span class="text-blue-600 font-semibold">6</span>
                                </div>
                                <div class="ml-4 text-left">
                                    <p class="text-sm font-medium text-gray-900">Supporting Documents</p>
                                    <p class="text-xs text-gray-500" id="step6Summary"></p>
                                </div>
                            </div>
                            <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                        </button>
                    </div>
                </div>

                <!-- Actions -->
                <div class="flex justify-between">
                    <button onclick="goBack()" class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50">
                        ← Back to My Requests
                    </button>
                    <div class="flex gap-3">
                        <button onclick="deleteDraft()" class="px-6 py-2 border border-red-300 text-red-600 rounded-lg hover:bg-red-50">
                            Delete Draft
                        </button>
                        <button onclick="reviewAndSubmit()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            Review & Submit →
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="hidden fixed bottom-4 right-4 px-6 py-4 rounded-lg shadow-lg z-50"></div>

    <script src="../assets/js/mock-data-complete.js"></script>
    <script src="../assets/js/validation.js"></script>
    <script src="../assets/js/state-management.js"></script>
    <script src="../assets/js/edge-cases.js"></script>
    <script src="../assets/js/sidebar.js"></script>
    <script>
        let draft = null;

        function initEditDraft() {
            const user = getCurrentUser();
            if (user) document.getElementById('currentUserName').textContent = user.nameEN;
            
            draft = loadDraft();
            if (!draft) {
                showToast('No draft found', 'error');
                setTimeout(() => window.location.href = 'my-requests.html', 2000);
                return;
            }
            
            populateDraftInfo();
            populateStepsSummary();
        }

        function populateDraftInfo() {
            document.getElementById('draftId').textContent = draft.id || 'DRAFT-' + Date.now();
            document.getElementById('lastSaved').textContent = draft.lastSaved ? formatDateTime(draft.lastSaved) : 'Just now';
            document.getElementById('draftTest').textContent = draft.testName || 'Not selected';
            document.getElementById('draftPatient').textContent = draft.patientName || 'Not entered';
        }

        function populateStepsSummary() {
            const steps = [
                { num: 1, title: 'Test Selection', data: draft.testName, summary: draft.testName || 'Not completed' },
                { num: 2, title: 'Patient Info', data: draft.patientName, summary: draft.patientName ? `${draft.patientName}, Age ${draft.patientAge}` : 'Not completed' },
                { num: 3, title: 'Symptoms', data: draft.symptoms, summary: draft.symptoms?.length ? `${draft.symptoms.length} symptoms` : 'Not completed' },
                { num: 4, title: 'ICD-10 Codes', data: draft.icd10Codes, summary: draft.icd10Codes?.length ? `${draft.icd10Codes.length} codes` : 'Not completed' },
                { num: 5, title: 'Justification', data: draft.justification, summary: draft.justification ? `${countWords(draft.justification)} words` : 'Not completed' },
                { num: 6, title: 'Documents', data: draft.documents, summary: draft.documents?.length ? `${draft.documents.length} files` : 'Not completed' }
            ];

            steps.forEach(step => {
                document.getElementById(`step${step.num}Summary`).textContent = step.summary;
            });

            const summaryHTML = steps.map(step => {
                const isComplete = step.data && (Array.isArray(step.data) ? step.data.length > 0 : true);
                return `
                    <div class="flex items-center justify-between p-3 border border-gray-200 rounded-lg">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 h-8 w-8 ${isComplete ? 'bg-green-100' : 'bg-gray-100'} rounded-full flex items-center justify-center">
                                ${isComplete ? '<svg class="h-5 w-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>' : '<span class="text-gray-400 text-sm">' + step.num + '</span>'}
                            </div>
                            <div class="ml-3">
                                <p class="text-sm font-medium text-gray-900">${step.title}</p>
                                <p class="text-xs text-gray-500">${step.summary}</p>
                            </div>
                        </div>
                        <button onclick="editStep(${step.num})" class="text-blue-600 hover:text-blue-800 text-sm">Edit</button>
                    </div>
                `;
            }).join('');

            document.getElementById('stepsSummary').innerHTML = summaryHTML;
        }

        function editStep(stepNum) {
            window.location.href = `create-step${stepNum}.html`;
        }

        function reviewAndSubmit() {
            window.location.href = 'create-step7.html';
        }

        function deleteDraft() {
            if (confirm('Are you sure you want to delete this draft? This action cannot be undone.')) {
                clearDraft();
                showToast('Draft deleted successfully', 'success');
                setTimeout(() => window.location.href = 'my-requests.html', 1500);
            }
        }

        function goBack() {
            window.location.href = 'my-requests.html';
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const colors = {success: 'bg-green-600 text-white', error: 'bg-red-600 text-white', info: 'bg-blue-600 text-white'};
            toast.className = `fixed bottom-4 right-4 px-6 py-4 rounded-lg shadow-lg z-50 ${colors[type]}`;
            toast.textContent = message;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }

        initEditDraft();
    </script>
</body>
</html>
